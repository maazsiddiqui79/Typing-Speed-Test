{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="dashboard-container">

    <!-- HEADER -->
    <div class="dashboard-header">
        <h1>Welcome back, {{ current_user.username }} üëã</h1>
    </div>

    <!-- ALL STATS TOP SECTION -->
    <div class="stats-top-grid">

        <div class="glass-panel stat-card">
            <h4>‚ö° Average WPM</h4>
            <p>{{ avg_wpm }}</p>
        </div>

        <div class="glass-panel stat-card">
            <h4>üèÜ Best WPM</h4>
            <p>{{ best_wpm }}</p>
        </div>

        <div class="glass-panel stat-card">
            <h4>üìù Tests Taken</h4>
            <p>{{ total_tests }}</p>
        </div>

        <div class="glass-panel stat-card">
            <h4>üìä Weekly Trend</h4>
            <p id="weeklyTrend">--</p>
        </div>

        <div class="glass-panel stat-card">
            <h4>üéØ Consistency</h4>
            <p id="consistencyScore">--</p>
        </div>

    </div>


    <!-- PROGRESS COMPARISON (IMPROVED UI) -->
    <div class="glass-panel comparison-section">
        <h3>üìà Performance Comparison</h3>

        <div class="comparison-grid">

            <div class="comparison-card">
                <span class="label">Today vs Last Week</span>
                <span class="value" id="todayVsWeek">--</span>
            </div>

            <div class="comparison-card">
                <span class="label">This Month vs Previous</span>
                <span class="value" id="monthComparison">--</span>
            </div>

            <div class="comparison-card">
                <span class="label">Highest Accuracy</span>
                <span class="value highlight" id="highestAccuracy">--</span>
            </div>

        </div>
    </div>


    <!-- PERFORMANCE TREND (RESTORED STYLE) -->
    <div class="glass-panel chart-section">
        <h3>Performance History</h3>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <!-- DANGER ZONE -->
    <div class="glass-panel" style="margin-top: 40px; padding: 30px; border-color: rgba(220, 38, 38, 0.3);">
        <h3 style="margin-bottom: 20px; color: var(--incorrect-color);">Danger Zone</h3>
        <p style="margin-bottom: 20px; color: var(--text-secondary);">Once you delete your data, there is no going back.
            Please be certain.</p>
        <button onclick="clearData()" class="btn" style="background: var(--incorrect-color); color: white;">Clear All
            Data</button>
    </div>


    <!-- MODE COMPARISON BAR -->
    <div class="glass-panel chart-section">
        <h3>Mode Comparison</h3>
        <div class="chart-container">
            <canvas id="modeChart"></canvas>
        </div>
    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function clearData() {
        if (confirm("Are you sure you want to delete ALL your typing history? This action cannot be undone.")) {
            fetch("{{ url_for('main.clear_data') }}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert("Failed to clear data.");
                    }
                });
        }
    }

    document.addEventListener("DOMContentLoaded", function () {

        const results = [
            {% for r in results %}
        {
            date: "{{ r.date_created.strftime('%m-%d') }}",
            fullDate: "{{ r.date_created.strftime('%Y-%m-%d') }}",
            wpm: {{ r.wpm }},
        accuracy: {{ r.accuracy }},
        mode: "{{ r.mode }}"
        },
        {% endfor %}
    ];

    if (results.length === 0) return;

    const wpms = results.map(r => r.wpm);
    const accuracies = results.map(r => r.accuracy);

    const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length || 0;

    /* WEEKLY TREND */
    const last7 = wpms.slice(-7);
    const prev7 = wpms.slice(-14, -7);
    const weeklyTrend = avg(last7) - avg(prev7);
    document.getElementById("weeklyTrend").innerText =
        weeklyTrend >= 0 ? `+${weeklyTrend.toFixed(1)}` : weeklyTrend.toFixed(1);

    /* CONSISTENCY */
    const mean = avg(wpms);
    const variance = avg(wpms.map(x => Math.pow(x - mean, 2)));
    const stdDev = Math.sqrt(variance);
    const consistency = Math.max(0, 100 - stdDev).toFixed(1);
    document.getElementById("consistencyScore").innerText = consistency + "%";

    /* COMPARISON CARDS */
    document.getElementById("todayVsWeek").innerText =
        `${avg(last7).toFixed(1)} vs ${avg(prev7).toFixed(1)} WPM`;

    const highestAccuracy = Math.max(...accuracies);
    document.getElementById("highestAccuracy").innerText = highestAccuracy + "%";

    /* MAIN PERFORMANCE CHART (CLEAN RESTORED STYLE) */
    new Chart(document.getElementById("progressChart"), {
        type: "line",
        data: {
            labels: results.map(r => r.date),
            datasets: [
                {
                    label: "WPM",
                    data: wpms,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: "Accuracy",
                    data: accuracies,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false
                }
            ]
        }
    });

    /* MODE COMPARISON */
    const modeMap = {};
    results.forEach(r => {
        if (!modeMap[r.mode]) modeMap[r.mode] = [];
        modeMap[r.mode].push(r.wpm);
    });

    const modeLabels = Object.keys(modeMap);
    const modeAverages = modeLabels.map(m => avg(modeMap[m]));

    new Chart(document.getElementById("modeChart"), {
        type: "bar",
        data: {
            labels: modeLabels,
            datasets: [{
                label: "Average WPM",
                data: modeAverages
            }]
        }
    });

});
</script>


<style>
    /* Layout */
    .dashboard-container {
        padding: 40px 20px;
        max-width: 1200px;
        margin: auto;
    }

    .dashboard-header h1 {
        margin-bottom: 40px;
    }

    /* TOP STATS */
    .stats-top-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        padding: 25px;
        text-align: center;
        border-radius: 18px;
    }

    .stat-card h4 {
        font-size: 0.9rem;
        margin-bottom: 10px;
        color: var(--text-secondary);
    }

    .stat-card p {
        font-size: 1.8rem;
        font-weight: 800;
    }

    /* COMPARISON UI IMPROVED */
    .comparison-section {
        padding: 35px;
        margin-bottom: 50px;
    }

    .comparison-section h3 {
        margin-bottom: 25px;
    }

    .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .comparison-card {
        padding: 25px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: 0.3s ease;
    }

    .comparison-card:hover {
        transform: translateY(-5px);
    }

    .comparison-card .label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .comparison-card .value {
        font-size: 1.6rem;
        font-weight: 800;
    }

    .highlight {
        color: var(--primary-neon);
    }

    /* CHART */
    .chart-section {
        padding: 40px;
        margin-bottom: 50px;
    }

    .chart-container {
        height: 350px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.5rem;
        }
    }
</style>

{% endblock %}